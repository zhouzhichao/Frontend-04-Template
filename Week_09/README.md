学习笔记

# 第9周浏览器工作原理  

## 1. HTML解析 | HTML parse模块的文件拆分  

### 第一步：拆分文件  

> + 为了方便文件管理， 把parser单独拆到文件中  
> + parseHTML接受HTML文本作为参数返回DON树

## 2.HTML解析 | 用FSM实现HTML的分析  

### 第二步总结

> + 我们用FSM来实现HTML的分析（有限状态机）  
> + 在HTML的标准中，已经规定了HTML的状态  
> + Toy-Browser只挑选其中一部分状态，完成一个最简版本  

## 3. HTML解析 | 解析标签  

### 第三步总结  

> + 主要标签有： 开始标签、结束标签、自封闭标签  

## 4. HTML解析 | 创建元素  

### 第四步总结  

> 状态机存在的意义，我们可以在各个状态里面添加自己的逻辑区，处理我们自己的业务  
>
> + 在状态机中，除了状态迁移，还要加入业务逻辑  
> + 我们在标签结束状态提交标签token  

## 5. HTML解析 | 处理属性  

### 第五步总结  

> + 属性分为单引号 双引号 无引号三种写法，因此需要比较多的状态  
> + 处理方式和标签类似

## 6. HTML解析 | 用token构建DOM树  

### 第六步总结  

> + 从标签构建DOM树的基本技巧就是使用栈  
> + 遇到开始标签创建元素入栈，遇到结束标签出栈  
> + 自封闭节点可视为入栈后立即出栈  
> + 任何元素的父元素是他入栈前的栈顶  

## 7. HTML解析 | 将文本节点加到DOM树  

### 第七步总结  

> + 文本节点与自封闭标签类似处理类似  
> + 多个文本节点需要合并  


# CSS computing  
 
npm install css  // 这个 CSS parser 可以帮助我们把 css 的代码变成 AST 抽象语法树这样的一个过程

## 第一步  收集 CSS 规则

> + 遇到style标签时，我们吧CSS规则保存起来  
> + 这里我们调用了CSS Parser 来分析CSS规则  
> + 这里我们必须要仔细的研究此库来分析CSS规则的样式  

## 第二步  添加调用  

CSS 设计 会尽量保证所有的选择器都能够在 startTag 进入的时候就能够被判断

> + 当我们创建一个元素后，立即计算CSS  
> + 理论上个当我们分析一个元素时， 所有css规则已经收集完毕  
> + 在真实的浏览器中，可能遇到写在body的style标签，需要从新计算css的情况，这里我们忽略

## 第三步  获取父元素序列  

> + 在computeCSS函数中，我们必须知道元素的所有父元素才能判断元素与规则是否匹配  
> + 我们从上一步骤的stack，可以获取本元素的所有父元素  
> + 因为我们首先获得的是 “当前元素” 所以我们获得和计算父元素的匹配顺讯是从内向外  

## 第四步  选择器与父元素的匹配  

> + 选择器也要从当前元素向外排列  
> + 复杂选择器拆成针对单个元素的选择器，用循环匹配父元素队列  

## 第五步  计算选择器与元素匹配  

> + 根据选择器的类型和元素属性，计算是否与当前元素匹配  
> + 这里仅仅只实现了三种基本选择器，实际的浏览器中要处理复合选择器  

## 第六步  生成 computed 属性  

> + 一旦选择匹配，就应用选择器到元素上，形成computeStyle  

## 第七步  specificity的计算逻辑  

> + CSS规则根据specificity和后来优先规则覆盖  
> + speccificity是一个四元组，越左边权重越高  
> + 一个CSS规则的specificity根据简单的选择器相加而成  